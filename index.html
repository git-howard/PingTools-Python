<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>网络Ping扫描工具</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f0f0;
            color: #2c3e50;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        h1 {
            text-align: center;
            color: #3498db;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .form-section {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #34495e;
        }

        input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        input[type="text"]:focus {
            border-color: #3498db;
            outline: none;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        button {
            background-color: #3498db;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 4px;
            font-size: 18px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            margin-right: 10px;
        }

        button:hover {
            background-color: #2980b9;
        }

        button:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }

        .results-section {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            font-size: 18px;
            font-weight: bold;
        }

        .ip-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
            gap: 10px;
        }

        .ip-card {
            padding: 8px;
            border-radius: 4px;
            text-align: center;
            font-weight: bold;
            transition: all 0.3s ease;
            min-width: 80px;
            font-size: 14px;
        }

        .ip-card .ip-address {
            font-size: 12px;
        }

        .ip-card.pending {
            background-color: #95a5a6;
            color: white;
        }

        .ip-card.online {
            background-color: #2ecc71;
            color: white;
        }

        .ip-card.offline {
            background-color: #e74c3c;
            color: white;
        }

        .ip-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .ip-segment-divider {
            height: 2px;
            background-color: #3498db;
            margin: 10px 0;
            border-radius: 1px;
            grid-column: 1 / -1;
        }

        .mac-info {
            font-size: 12px;
            margin-top: 5px;
            font-weight: normal;
        }

        .hostname-info {
            font-size: 12px;
            margin-top: 5px;
            font-weight: normal;
            color: #3498db;
        }

        .vendor-info {
            font-size: 10px;
            margin-top: 3px;
            font-weight: normal;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #bdc3c7;
            border-radius: 10px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background-color: #3498db;
            width: 0%;
            transition: width 0.3s ease;
            text-align: center;
            color: white;
            font-weight: bold;
            line-height: 20px;
            font-size: 14px;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .example {
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 5px;
        }

        .stats {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            font-size: 18px;
            font-weight: bold;
        }

        .online-count {
            color: #2ecc71;
        }

        .offline-count {
            color: #e74c3c;
        }

        .total-count {
            color: #3498db;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>网络Ping扫描工具</h1>

        <div class="form-section">
            <div class="form-group">
                <label for="ipRange">IP地址范围:</label>
                <input type="text" id="ipRange" placeholder="例如: 192.168.1.0/24 或 192.168.1.1-100">
                <div class="example">示例: 192.168.1.0/24 (整个子网) 或 192.168.1.1-100 (范围)</div>
            </div>
            <div class="form-group">
                <label for="detectionPorts">检测端口:</label>
                <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                    <div id="portList" style="display: flex; gap: 5px; flex-wrap: wrap; margin-bottom: 10px;"></div>
                    <input type="number" id="newPort" placeholder="添加端口" min="1" max="65535" style="width: 120px;">
                    <button id="addPort" style="padding: 8px 16px; font-size: 14px;">添加</button>
                    <button id="savePorts" style="padding: 8px 16px; font-size: 14px; background-color: #2ecc71;">保存</button>
                    <span id="portStatus" style="color: #7f8c8d; font-size: 12px;"></span>
                </div>
            </div>
            <div class="form-group">
                <label for="threadCount">线程数:</label>
                <select id="threadCount">
                    <option value="10">10</option>
                    <option value="20">20</option>
                    <option value="50" selected>50</option>
                    <option value="100">100</option>
                    <option value="200">200</option>
                </select>
            </div>
            <button id="startScan">开始扫描</button>
            <button id="stopScan" disabled>停止扫描</button>
            <button id="exportBtn" disabled>导出结果</button>
        </div>

        <div class="results-section">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill">0%</div>
            </div>
            <div class="stats">
                <div class="online-count">在线: <span id="onlineCount">0</span></div>
                <div class="offline-count">离线: <span id="offlineCount">0</span></div>
                <div class="total-count">总数: <span id="totalCount">0</span></div>
            </div>
            <div class="status-bar">
                <div>状态: <span id="status">就绪</span></div>
                <div id="elapsedTime">耗时: 0秒</div>
            </div>
            <div class="ip-grid" id="resultsGrid"></div>
        </div>
    </div>

    <script>
        // 端口管理功能
        let currentPorts = [];

        // 加载当前端口
        function loadPorts() {
            fetch('/detection-ports')
                .then(response => response.json())
                .then(ports => {
                    currentPorts = ports;
                    renderPorts();
                })
                .catch(error => console.error('Error loading ports:', error));
        }

        // 渲染端口列表
        function renderPorts() {
            const portList = document.getElementById('portList');
            portList.innerHTML = '';
            
            currentPorts.forEach((port, index) => {
                const portItem = document.createElement('div');
                portItem.style.display = 'flex';
                portItem.style.alignItems = 'center';
                portItem.style.gap = '5px';
                
                const portText = document.createElement('span');
                portText.textContent = port;
                portText.style.padding = '5px 10px';
                portText.style.border = '1px solid #bdc3c7';
                portText.style.borderRadius = '4px';
                portText.style.backgroundColor = '#ecf0f1';
                
                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = '×';
                deleteBtn.style.padding = '2px 6px';
                deleteBtn.style.fontSize = '14px';
                deleteBtn.style.border = 'none';
                deleteBtn.style.borderRadius = '4px';
                deleteBtn.style.backgroundColor = '#e74c3c';
                deleteBtn.style.color = 'white';
                deleteBtn.style.cursor = 'pointer';
                deleteBtn.onclick = () => removePort(index);
                
                portItem.appendChild(portText);
                portItem.appendChild(deleteBtn);
                portList.appendChild(portItem);
            });
        }

        // 添加端口
        document.getElementById('addPort').addEventListener('click', function() {
            const newPortInput = document.getElementById('newPort');
            const newPort = parseInt(newPortInput.value);
            
            if (isNaN(newPort) || newPort < 1 || newPort > 65535) {
                alert('请输入有效的端口号 (1-65535)');
                return;
            }
            
            if (!currentPorts.includes(newPort)) {
                currentPorts.push(newPort);
                currentPorts.sort((a, b) => a - b);
                renderPorts();
                newPortInput.value = '';
            } else {
                alert('端口已存在');
            }
        });

        // 删除端口
        function removePort(index) {
            currentPorts.splice(index, 1);
            renderPorts();
        }

        // 保存端口
        document.getElementById('savePorts').addEventListener('click', function() {
            const statusSpan = document.getElementById('portStatus');
            
            fetch('/detection-ports', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ ports: currentPorts })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    statusSpan.textContent = '端口已保存';
                    statusSpan.style.color = '#2ecc71';
                    // 重置状态信息
                    setTimeout(() => {
                        statusSpan.textContent = '';
                    }, 2000);
                } else {
                    statusSpan.textContent = '保存失败: ' + data.error;
                    statusSpan.style.color = '#e74c3c';
                }
            })
            .catch(error => {
                statusSpan.textContent = '保存失败: ' + error.message;
                statusSpan.style.color = '#e74c3c';
            });
        });

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            loadPorts();
        });

        // 原来的IP处理函数
        function getIpList(ipRange) {
                try {
                    // 支持多段IP地址，使用分号分隔
                    const ranges = ipRange.split(';').map(range => range.trim()).filter(range => range);
                    let allIps = [];
                    let segments = [];
                    
                    for (const singleRange of ranges) {
                        if (singleRange.includes('/')) {
                            const [ipPart, prefixPart] = singleRange.split('/');
                            const prefix = parseInt(prefixPart);
                            
                            const ipOctets = ipPart.split('.').map(Number);
                            if (ipOctets.length !== 4 || ipOctets.some(octet => isNaN(octet) || octet < 0 || octet > 255)) {
                                continue;
                            }
                            
                            const mask = (Math.pow(2, prefix) - 1) << (32 - prefix);
                            const networkInt = (ipOctets[0] << 24) | (ipOctets[1] << 16) | (ipOctets[2] << 8) | ipOctets[3];
                            const network = networkInt & mask;
                            const firstHost = network + 1;
                            const lastHost = (network | (Math.pow(2, 32 - prefix) - 1)) - 1;
                            
                            const ipList = [];
                            for (let i = firstHost; i <= lastHost; i++) {
                                const ip = `${(i >> 24) & 0xFF}.${(i >> 16) & 0xFF}.${(i >> 8) & 0xFF}.${i & 0xFF}`;
                                ipList.push(ip);
                            }
                            allIps = allIps.concat(ipList);
                            segments.push({ range: singleRange, ips: [...ipList] });
                        } else if (singleRange.includes('-')) {
                            const [startPart, endPart] = singleRange.split('-').map(part => part.trim());
                            const startOctets = startPart.split('.').map(Number);
                            
                            if (startOctets.length !== 4 || startOctets.some(octet => isNaN(octet) || octet < 0 || octet > 255)) {
                                continue;
                            }
                            
                            let endOctets;
                            if (endPart.includes('.')) {
                                endOctets = endPart.split('.').map(Number);
                                if (endOctets.length !== 4 || endOctets.some(octet => isNaN(octet) || octet < 0 || octet > 255)) {
                                    continue;
                                }
                            } else {
                                const endOctet = parseInt(endPart);
                                if (isNaN(endOctet) || endOctet < 0 || endOctet > 255) {
                                    continue;
                                }
                                endOctets = [...startOctets];
                                endOctets[3] = endOctet;
                            }
                            
                            const startInt = (startOctets[0] << 24) | (startOctets[1] << 16) | (startOctets[2] << 8) | startOctets[3];
                            const endInt = (endOctets[0] << 24) | (endOctets[1] << 16) | (endOctets[2] << 8) | endOctets[3];
                            
                            if (startInt > endInt) {
                                continue;
                            }
                            
                            const ipList = [];
                            for (let i = startInt; i <= endInt; i++) {
                                const ip = `${(i >> 24) & 0xFF}.${(i >> 16) & 0xFF}.${(i >> 8) & 0xFF}.${i & 0xFF}`;
                                ipList.push(ip);
                            }
                            allIps = allIps.concat(ipList);
                            segments.push({ range: singleRange, ips: [...ipList] });
                        } else {
                            const ipOctets = singleRange.trim().split('.').map(Number);
                            if (ipOctets.length === 4 && ipOctets.every(octet => !isNaN(octet) && octet >= 0 && octet <= 255)) {
                                const ip = singleRange.trim();
                                allIps.push(ip);
                                segments.push({ range: singleRange, ips: [ip] });
                            }
                        }
                    }
                    
                    // 去重
                    const uniqueIps = [...new Set(allIps)];
                    
                    // 排序
                    uniqueIps.sort((a, b) => {
                        const aParts = a.split('.').map(Number);
                        const bParts = b.split('.').map(Number);
                        for (let i = 0; i < 4; i++) {
                            if (aParts[i] !== bParts[i]) {
                                return aParts[i] - bParts[i];
                            }
                        }
                        return 0;
                    });
                    
                    // 返回IP列表和分段信息
                    return { ips: uniqueIps, segments: segments };
                } catch (error) {
                    console.error('Error parsing IP range:', error);
                    return { ips: [], segments: [] };
                }
            }
        document.addEventListener('DOMContentLoaded', function() {
            const startBtn = document.getElementById('startScan');
            const stopBtn = document.getElementById('stopScan');
            const ipRangeInput = document.getElementById('ipRange');
            const progressFill = document.getElementById('progressFill');
            const resultsGrid = document.getElementById('resultsGrid');
            const statusSpan = document.getElementById('status');
            const onlineCountSpan = document.getElementById('onlineCount');
            const offlineCountSpan = document.getElementById('offlineCount');
            const totalCountSpan = document.getElementById('totalCount');
            const elapsedTimeSpan = document.getElementById('elapsedTime');
            const exportBtn = document.getElementById('exportBtn');

            let isScanning = false;
            let scanResults = [];

            function parseIpRange(ipRange) {
                const parts = ipRange.split('-');
                if (parts.length === 2) {
                    const startIp = parts[0].trim();
                    const endPart = parts[1].trim();
                    const startParts = startIp.split('.');
                    // Check if start IP is valid (4 octets)
                    if (startParts.length === 4) {
                        const base = startParts.slice(0, 3).join('.');
                        // Check if end part is a single octet (0-255)
                        if (/^\d+$/.test(endPart)) {
                            const endOctet = parseInt(endPart);
                            if (endOctet >= 0 && endOctet <= 255) {
                                // Form complete end IP
                                const endIp = `${base}.${endOctet}`;
                                return `${startIp}-${endIp}`;
                            }
                        }
                    }
                    // If range format is invalid, return as entered
                    return `${startIp}-${endPart}`;
                } else if (ipRange.includes('/')) {
                    return ipRange;
                } else {
                    return ipRange;
                }
            }

            startBtn.addEventListener('click', function() {
                const ipRange = ipRangeInput.value.trim();
                console.log('Original IP range:', ipRange);
                if (!ipRange) {
                    alert('请输入IP地址范围');
                    return;
                }
                const parsedRange = parseIpRange(ipRange);
                console.log('Parsed IP range:', parsedRange);

                // 生成所有IP列表
                const ipListResult = getIpList(parsedRange);
                const allIps = ipListResult.ips;
                const segments = ipListResult.segments;
                if (allIps.length === 0) {
                    alert('无效的IP范围');
                    return;
                }

                isScanning = true;
                startBtn.disabled = true;
                stopBtn.disabled = false;
                statusSpan.textContent = '扫描中';

                // 清空之前的结果
                resultsGrid.innerHTML = '';
                onlineCountSpan.textContent = '0';
                offlineCountSpan.textContent = '0';
                totalCountSpan.textContent = allIps.length;
                progressFill.style.width = '0%';
                progressFill.textContent = '0%';
                scanResults = [];
                exportBtn.disabled = true;

                // 创建IP到段的映射，用于确定每个IP属于哪个段
                const ipToSegment = new Map();
                for (const segment of segments) {
                    for (const ip of segment.ips) {
                        if (!ipToSegment.has(ip)) {
                            ipToSegment.set(ip, segment);
                        }
                    }
                }
                
                // 预创建所有IP卡片，初始状态为pending
                const ipCardMap = new Map();
                let previousSegment = null;
                
                allIps.forEach(ip => {
                    const currentSegment = ipToSegment.get(ip);
                    
                    // 如果当前IP与上一个IP属于不同的段，则添加分割线
                    if (previousSegment !== null && previousSegment !== currentSegment) {
                        const divider = document.createElement('div');
                        divider.className = 'ip-segment-divider';
                        resultsGrid.appendChild(divider);
                    }
                    
                    // 创建IP卡片
                    const ipCard = document.createElement('div');
                    ipCard.className = 'ip-card pending';
                    ipCard.innerHTML = `<div class="ip-address">${ip}</div>`;
                    resultsGrid.appendChild(ipCard);
                    ipCardMap.set(ip, ipCard);
                    
                    // 更新上一个段
                    previousSegment = currentSegment;
                });

                const startTime = Date.now();

                // 更新耗时
                const elapsedTimer = setInterval(() => {
                    const elapsed = Math.floor((Date.now() - startTime) / 1000);
                    elapsedTimeSpan.textContent = `耗时: ${elapsed}秒`;
                }, 1000);

                fetch('/scan', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        ip_range: parseIpRange(ipRange),
                        concurrency: parseInt(document.getElementById('threadCount').value)
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(errorData => {
                            throw new Error(errorData.error || 'Network response was not ok');
                        });
                    }
                    
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder('utf-8');
                    let buffer = '';
                    let total = allIps.length;
                    let onlineCount = 0;
                    let offlineCount = 0;

                    // 处理流数据
                    function processStream() {
                        reader.read().then(({ done, value }) => {
                            if (done) {
                        isScanning = false;
                        startBtn.disabled = false;
                        stopBtn.disabled = true;
                        statusSpan.textContent = '扫描完成';
                        clearInterval(elapsedTimer);
                        const totalTime = Math.floor((Date.now() - startTime) / 1000);
                        elapsedTimeSpan.textContent = `耗时: ${totalTime}秒`;
                        // 启用导出按钮
                        exportBtn.disabled = false;
                        return;
                    }

                            // 解码接收到的数据
                            const chunk = decoder.decode(value, { stream: true });
                            buffer += chunk;

                            // 按行分割数据
                            const lines = buffer.split('\n');
                            buffer = lines.pop(); // 保存不完整的最后一行

                            // 处理每一行数据
                            lines.forEach(line => {
                                line = line.trim();
                                if (line.startsWith('data:')) {
                                    const dataPart = line.slice(5).trim();
                                    if (dataPart) {
                                        try {
                                            const message = JSON.parse(dataPart);
                                            
                                            if (message.type === 'result') {
                                                // 接收单个IP的扫描结果
                                                const result = message;
                                                
                                                // 从地图中获取对应的卡片
                                                const ipCard = ipCardMap.get(result.ip);
                                                if (ipCard) {
                                                    // 更新卡片状态
                                                    ipCard.className = `ip-card ${result.success ? 'online' : 'offline'}`;
                                                    ipCard.innerHTML = `<div class="ip-address">${result.ip}</div>`;

                                                if (result.success) {
                                                    // 显示主机名
                                                    if (result.hostname) {
                                                        ipCard.innerHTML += `<div class="hostname-info">${result.hostname}</div>`;
                                                    }
                                                    // 显示MAC地址
                                                    if (result.mac) {
                                                        ipCard.innerHTML += `<div class="mac-info">${result.mac}</div>`;
                                                        // 显示厂商信息
                                                        if (result.vendor) {
                                                            ipCard.innerHTML += `<div class="vendor-info">${result.vendor}</div>`;
                                                        }
                                                    }
                                                }
                                                }
                                                
                                                // 更新计数
                                                if (result.success) {
                                                    onlineCount++;
                                                } else {
                                                    offlineCount++;
                                                }

                                                // 更新进度
                                                const progress = Math.floor(((onlineCount + offlineCount) / total) * 100);
                                                progressFill.style.width = `${progress}%`;
                                                progressFill.textContent = `${progress}%`;

                                                onlineCountSpan.textContent = onlineCount;
                                                offlineCountSpan.textContent = offlineCount;

                                                // 保存结果用于导出
                                                const formattedResult = {
                                                    ip: result.ip,
                                                    status: result.success ? 'online' : 'offline',
                                                    hostname: result.hostname || '',
                                                    mac: result.mac || '',
                                                    vendor: result.vendor || ''
                                                };
                                                scanResults.push(formattedResult);
                                            }
                                        } catch (error) {
                                            console.error('Failed to parse SSE message:', error);
                                        }
                                    }
                                }
                            });

                            // 继续处理流
                            processStream();
                        }).catch(error => {
                            console.error('Stream error:', error);
                            isScanning = false;
                            startBtn.disabled = false;
                            stopBtn.disabled = true;
                            statusSpan.textContent = '扫描失败';
                            clearInterval(elapsedTimer);
                        });
                    }

                    // 开始处理流
                    processStream();
                })
                .catch(error => {
                    console.error('Fetch error:', error);
                    statusSpan.textContent = '扫描失败';
                    startBtn.disabled = false;
                    stopBtn.disabled = true;
                    clearInterval(elapsedTimer);
                });
            });

            // 导出结果点击事件
            exportBtn.addEventListener('click', () => {
                if (scanResults.length === 0) {
                    alert('没有结果可导出');
                    return;
                }

                statusSpan.textContent = '正在导出结果...';

                fetch('/export', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        results: scanResults
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(errorData => {
                            throw new Error(errorData.error || '导出失败');
                        });
                    }
                    return response.blob();
                })
                .then(blob => {
                    // 处理下载
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'ping_scan_results.xlsx';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    statusSpan.textContent = '扫描完成';
                })
                .catch(error => {
                    console.error('导出错误:', error);
                    alert('导出失败: ' + error.message);
                    statusSpan.textContent = '扫描完成';
                });
            });

            stopBtn.addEventListener('click', function() {
                isScanning = false;
                stopBtn.disabled = true;
                startBtn.disabled = false;
                statusSpan.textContent = '已停止';
            });
        });

        // 版本检查功能
        function checkVersion() {
            const localVersion = document.getElementById('localVersion').textContent;
            const versionUpdate = document.getElementById('versionUpdate');
            
            // 先获取版本检查配置
            fetch('/version-check-config')
                .then(response => response.json())
                .then(config => {
                    if (!config.enable_version_check) {
                        console.log('版本检查已禁用');
                        return;
                    }
                    
                    const versionCheckUrl = '/version-check'; // 使用后端代理端点
                    const maxAttempts = config.version_check_max_attempts || 3;
                    const timeout = (config.version_check_timeout || 5) * 1000; // Convert seconds to milliseconds
                    let attempt = 0;
                    
                    function attemptCheck() {
                        attempt++; 
                        console.log(`尝试版本检查 (${attempt}/${maxAttempts})...`);
                        // 使用fetch API实现版本检查并手动处理超时
                        const fetchWithTimeout = fetch(versionCheckUrl, { method: 'GET' })
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error(`网络响应错误: ${response.status}`);
                                }
                                return response.text();
                            });
                        
                        // 创建超时Promise
                        const timeoutPromise = new Promise((_, reject) => {
                            setTimeout(() => reject(new Error('请求超时')), timeout);
                        });
                        
                        // 竞速Promise：先完成的先返回
                        Promise.race([fetchWithTimeout, timeoutPromise])
                            .then(data => {
                                const cleanLocal = localVersion.trim();
                                const cleanRemote = data.trim();
                                
                                if (cleanRemote > cleanLocal) {
                                    versionUpdate.innerHTML = `发现新版本 ${cleanRemote}，点击 <a href="http://nas.shanghaiit.com:88/PingTool.rar" target="_blank">下载</a>`;
                                } else {
                                    versionUpdate.innerHTML = '';
                                }
                            })
                            .catch(error => {
                                handleError(error);
                            });
                    }
                    
                    function handleError(error) {
                            // 版本检查失败时不显示控制台错误
                            if (attempt < maxAttempts) {
                                // 重试
                                setTimeout(attemptCheck, 1000 * attempt);
                            } else {
                                // 尝试了所有次数后仍失败，不显示错误
                                versionUpdate.innerHTML = '';
                            }
                        }
                    
                    attemptCheck(); // 开始检查
                })
                .catch(error => {
                    // 获取版本检查配置失败时不显示控制台错误
                    // 获取配置失败时不显示错误信息
                    versionUpdate.innerHTML = '';
                });
        }
        
        // 页面加载完成后执行版本检查
        document.addEventListener('DOMContentLoaded', checkVersion);
    </script>
    <div style="text-align: center; margin: 20px 0;">
        <p>作者: <a href="https://github.com/git-howard/" target="_blank">https://github.com/git-howard/</a> | 版本: <span id="localVersion">0.2</span></p>
        <div id="versionUpdate" style="color: red; margin-top: 10px; cursor: pointer;"></div>
    </div>
</body>
</html>