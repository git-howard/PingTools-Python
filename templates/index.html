<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>网络Ping扫描工具</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f0f0;
            color: #2c3e50;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        h1 {
            text-align: center;
            color: #3498db;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .form-section {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #34495e;
        }

        input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        input[type="text"]:focus {
            border-color: #3498db;
            outline: none;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        button {
            background-color: #3498db;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 4px;
            font-size: 18px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            margin-right: 10px;
        }

        button:hover {
            background-color: #2980b9;
        }

        button:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }

        .results-section {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            font-size: 18px;
            font-weight: bold;
        }

        .ip-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
            gap: 10px;
        }

        .ip-card {
            padding: 8px;
            border-radius: 4px;
            text-align: center;
            font-weight: bold;
            transition: all 0.3s ease;
            min-width: 80px;
            font-size: 14px;
        }

        .ip-card .ip-address {
            font-size: 12px;
        }

        .ip-card.pending {
            background-color: #95a5a6;
            color: white;
        }

        .ip-card.online {
            background-color: #2ecc71;
            color: white;
        }

        .ip-card.offline {
            background-color: #e74c3c;
            color: white;
        }

        .ip-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .mac-info {
            font-size: 12px;
            margin-top: 5px;
            font-weight: normal;
        }

        .hostname-info {
            font-size: 12px;
            margin-top: 5px;
            font-weight: normal;
            color: #3498db;
        }

        .vendor-info {
            font-size: 10px;
            margin-top: 3px;
            font-weight: normal;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #bdc3c7;
            border-radius: 10px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background-color: #3498db;
            width: 0%;
            transition: width 0.3s ease;
            text-align: center;
            color: white;
            font-weight: bold;
            line-height: 20px;
            font-size: 14px;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .example {
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 5px;
        }

        .stats {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            font-size: 18px;
            font-weight: bold;
        }

        .online-count {
            color: #2ecc71;
        }

        .offline-count {
            color: #e74c3c;
        }

        .total-count {
            color: #3498db;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>网络Ping扫描工具</h1>

        <div class="form-section">
            <div class="form-group">
                <label for="ipRange">IP地址范围:</label>
                <input type="text" id="ipRange" placeholder="例如: 192.168.1.0/24 或 192.168.1.1-100">
                <div class="example">示例: 192.168.1.0/24 (整个子网) 或 192.168.1.1-100 (范围)</div>
            </div>
            <div class="form-group">
                <label for="threadCount">线程数:</label>
                <select id="threadCount">
                    <option value="10">10</option>
                    <option value="20">20</option>
                    <option value="50" selected>50</option>
                    <option value="100">100</option>
                    <option value="200">200</option>
                </select>
            </div>
            <button id="startScan">开始扫描</button>
            <button id="stopScan" disabled>停止扫描</button>
            <button id="exportBtn" disabled>导出结果</button>
        </div>

        <div class="results-section">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill">0%</div>
            </div>
            <div class="stats">
                <div class="online-count">在线: <span id="onlineCount">0</span></div>
                <div class="offline-count">离线: <span id="offlineCount">0</span></div>
                <div class="total-count">总数: <span id="totalCount">0</span></div>
            </div>
            <div class="status-bar">
                <div>状态: <span id="status">就绪</span></div>
                <div id="elapsedTime">耗时: 0秒</div>
            </div>
            <div class="ip-grid" id="resultsGrid"></div>
        </div>
    </div>

    <script>
            function getIpList(ipRange) {
                try {
                    if (ipRange.includes('/')) {
                        const [ipPart, prefixPart] = ipRange.split('/');
                        const prefix = parseInt(prefixPart);
                        
                        const ipOctets = ipPart.split('.').map(Number);
                        if (ipOctets.length !== 4 || ipOctets.some(octet => isNaN(octet) || octet < 0 || octet > 255)) {
                            return [];
                        }
                        
                        const mask = (Math.pow(2, prefix) - 1) << (32 - prefix);
                        const networkInt = (ipOctets[0] << 24) | (ipOctets[1] << 16) | (ipOctets[2] << 8) | ipOctets[3];
                        const network = networkInt & mask;
                        const firstHost = network + 1;
                        const lastHost = (network | (Math.pow(2, 32 - prefix) - 1)) - 1;
                        
                        const ipList = [];
                        for (let i = firstHost; i <= lastHost; i++) {
                            const ip = `${(i >> 24) & 0xFF}.${(i >> 16) & 0xFF}.${(i >> 8) & 0xFF}.${i & 0xFF}`;
                            ipList.push(ip);
                        }
                        return ipList;
                    } else if (ipRange.includes('-')) {
                        const [startPart, endPart] = ipRange.split('-').map(part => part.trim());
                        const startOctets = startPart.split('.').map(Number);
                        
                        if (startOctets.length !== 4 || startOctets.some(octet => isNaN(octet) || octet < 0 || octet > 255)) {
                            return [];
                        }
                        
                        let endOctets;
                        if (endPart.includes('.')) {
                            endOctets = endPart.split('.').map(Number);
                            if (endOctets.length !== 4 || endOctets.some(octet => isNaN(octet) || octet < 0 || octet > 255)) {
                                return [];
                            }
                        } else {
                            const endOctet = parseInt(endPart);
                            if (isNaN(endOctet) || endOctet < 0 || endOctet > 255) {
                                return [];
                            }
                            endOctets = [...startOctets];
                            endOctets[3] = endOctet;
                        }
                        
                        const startInt = (startOctets[0] << 24) | (startOctets[1] << 16) | (startOctets[2] << 8) | startOctets[3];
                        const endInt = (endOctets[0] << 24) | (endOctets[1] << 16) | (endOctets[2] << 8) | endOctets[3];
                        
                        if (startInt > endInt) {
                            return [];
                        }
                        
                        const ipList = [];
                        for (let i = startInt; i <= endInt; i++) {
                            const ip = `${(i >> 24) & 0xFF}.${(i >> 16) & 0xFF}.${(i >> 8) & 0xFF}.${i & 0xFF}`;
                            ipList.push(ip);
                        }
                        return ipList;
                    } else {
                        const ipOctets = ipRange.trim().split('.').map(Number);
                        if (ipOctets.length === 4 && ipOctets.every(octet => !isNaN(octet) && octet >= 0 && octet <= 255)) {
                            return [ipRange.trim()];
                        }
                        return [];
                    }
                } catch (error) {
                    console.error('Error parsing IP range:', error);
                    return [];
                }
            }
        document.addEventListener('DOMContentLoaded', function() {
            const startBtn = document.getElementById('startScan');
            const stopBtn = document.getElementById('stopScan');
            const ipRangeInput = document.getElementById('ipRange');
            const progressFill = document.getElementById('progressFill');
            const resultsGrid = document.getElementById('resultsGrid');
            const statusSpan = document.getElementById('status');
            const onlineCountSpan = document.getElementById('onlineCount');
            const offlineCountSpan = document.getElementById('offlineCount');
            const totalCountSpan = document.getElementById('totalCount');
            const elapsedTimeSpan = document.getElementById('elapsedTime');
            const exportBtn = document.getElementById('exportBtn');

            let isScanning = false;
            let scanResults = [];

            function parseIpRange(ipRange) {
                const parts = ipRange.split('-');
                if (parts.length === 2) {
                    const startIp = parts[0].trim();
                    const endPart = parts[1].trim();
                    const startParts = startIp.split('.');
                    // Check if start IP is valid (4 octets)
                    if (startParts.length === 4) {
                        const base = startParts.slice(0, 3).join('.');
                        // Check if end part is a single octet (0-255)
                        if (/^\d+$/.test(endPart)) {
                            const endOctet = parseInt(endPart);
                            if (endOctet >= 0 && endOctet <= 255) {
                                // Form complete end IP
                                const endIp = `${base}.${endOctet}`;
                                return `${startIp}-${endIp}`;
                            }
                        }
                    }
                    // If range format is invalid, return as entered
                    return `${startIp}-${endPart}`;
                } else if (ipRange.includes('/')) {
                    return ipRange;
                } else {
                    return ipRange;
                }
            }

            startBtn.addEventListener('click', function() {
                const ipRange = ipRangeInput.value.trim();
                console.log('Original IP range:', ipRange);
                if (!ipRange) {
                    alert('请输入IP地址范围');
                    return;
                }
                const parsedRange = parseIpRange(ipRange);
                console.log('Parsed IP range:', parsedRange);

                // 生成所有IP列表
                const allIps = getIpList(parsedRange);
                if (allIps.length === 0) {
                    alert('无效的IP范围');
                    return;
                }

                isScanning = true;
                startBtn.disabled = true;
                stopBtn.disabled = false;
                statusSpan.textContent = '扫描中';

                // 清空之前的结果
                resultsGrid.innerHTML = '';
                onlineCountSpan.textContent = '0';
                offlineCountSpan.textContent = '0';
                totalCountSpan.textContent = allIps.length;
                progressFill.style.width = '0%';
                progressFill.textContent = '0%';
                scanResults = [];
                exportBtn.disabled = true;

                // 预创建所有IP卡片，初始状态为pending
                const ipCardMap = new Map();
                allIps.forEach(ip => {
                    const ipCard = document.createElement('div');
                    ipCard.className = 'ip-card pending';
                    ipCard.innerHTML = `<div class="ip-address">${ip}</div>`;
                    resultsGrid.appendChild(ipCard);
                    ipCardMap.set(ip, ipCard);
                });

                const startTime = Date.now();

                // 更新耗时
                const elapsedTimer = setInterval(() => {
                    const elapsed = Math.floor((Date.now() - startTime) / 1000);
                    elapsedTimeSpan.textContent = `耗时: ${elapsed}秒`;
                }, 1000);

                fetch('/scan', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        ip_range: parseIpRange(ipRange),
                        concurrency: parseInt(document.getElementById('threadCount').value)
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(errorData => {
                            throw new Error(errorData.error || 'Network response was not ok');
                        });
                    }
                    
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder('utf-8');
                    let buffer = '';
                    let total = allIps.length;
                    let onlineCount = 0;
                    let offlineCount = 0;

                    // 处理流数据
                    function processStream() {
                        reader.read().then(({ done, value }) => {
                            if (done) {
                        isScanning = false;
                        startBtn.disabled = false;
                        stopBtn.disabled = true;
                        statusSpan.textContent = '扫描完成';
                        clearInterval(elapsedTimer);
                        const totalTime = Math.floor((Date.now() - startTime) / 1000);
                        elapsedTimeSpan.textContent = `耗时: ${totalTime}秒`;
                        // 启用导出按钮
                        exportBtn.disabled = false;
                        return;
                    }

                            // 解码接收到的数据
                            const chunk = decoder.decode(value, { stream: true });
                            buffer += chunk;

                            // 按行分割数据
                            const lines = buffer.split('\n');
                            buffer = lines.pop(); // 保存不完整的最后一行

                            // 处理每一行数据
                            lines.forEach(line => {
                                line = line.trim();
                                if (line.startsWith('data:')) {
                                    const dataPart = line.slice(5).trim();
                                    if (dataPart) {
                                        try {
                                            const message = JSON.parse(dataPart);
                                            
                                            if (message.type === 'result') {
                                                // 接收单个IP的扫描结果
                                                const result = message;
                                                
                                                // 从地图中获取对应的卡片
                                                const ipCard = ipCardMap.get(result.ip);
                                                if (ipCard) {
                                                    // 更新卡片状态
                                                    ipCard.className = `ip-card ${result.success ? 'online' : 'offline'}`;
                                                    ipCard.innerHTML = `<div class="ip-address">${result.ip}</div>`;

                                                if (result.success) {
                                                    // 显示主机名
                                                    if (result.hostname) {
                                                        ipCard.innerHTML += `<div class="hostname-info">${result.hostname}</div>`;
                                                    }
                                                    // 显示MAC地址
                                                    if (result.mac) {
                                                        ipCard.innerHTML += `<div class="mac-info">${result.mac}</div>`;
                                                        // 显示厂商信息
                                                        if (result.vendor) {
                                                            ipCard.innerHTML += `<div class="vendor-info">${result.vendor}</div>`;
                                                        }
                                                    }
                                                }
                                                }
                                                
                                                // 更新计数
                                                if (result.success) {
                                                    onlineCount++;
                                                } else {
                                                    offlineCount++;
                                                }

                                                // 更新进度
                                                const progress = Math.floor(((onlineCount + offlineCount) / total) * 100);
                                                progressFill.style.width = `${progress}%`;
                                                progressFill.textContent = `${progress}%`;

                                                onlineCountSpan.textContent = onlineCount;
                                                offlineCountSpan.textContent = offlineCount;

                                                // 保存结果用于导出
                                                const formattedResult = {
                                                    ip: result.ip,
                                                    status: result.success ? 'online' : 'offline',
                                                    hostname: result.hostname || '',
                                                    mac: result.mac || '',
                                                    vendor: result.vendor || ''
                                                };
                                                scanResults.push(formattedResult);
                                            }
                                        } catch (error) {
                                            console.error('Failed to parse SSE message:', error);
                                        }
                                    }
                                }
                            });

                            // 继续处理流
                            processStream();
                        }).catch(error => {
                            console.error('Stream error:', error);
                            isScanning = false;
                            startBtn.disabled = false;
                            stopBtn.disabled = true;
                            statusSpan.textContent = '扫描失败';
                            clearInterval(elapsedTimer);
                        });
                    }

                    // 开始处理流
                    processStream();
                })
                .catch(error => {
                    console.error('Fetch error:', error);
                    statusSpan.textContent = '扫描失败';
                    startBtn.disabled = false;
                    stopBtn.disabled = true;
                    clearInterval(elapsedTimer);
                });
            });

            // 导出结果点击事件
            exportBtn.addEventListener('click', () => {
                if (scanResults.length === 0) {
                    alert('没有结果可导出');
                    return;
                }

                statusSpan.textContent = '正在导出结果...';

                fetch('/export', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        results: scanResults
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(errorData => {
                            throw new Error(errorData.error || '导出失败');
                        });
                    }
                    return response.blob();
                })
                .then(blob => {
                    // 处理下载
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'ping_scan_results.xlsx';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    statusSpan.textContent = '扫描完成';
                })
                .catch(error => {
                    console.error('导出错误:', error);
                    alert('导出失败: ' + error.message);
                    statusSpan.textContent = '扫描完成';
                });
            });

            stopBtn.addEventListener('click', function() {
                isScanning = false;
                stopBtn.disabled = true;
                startBtn.disabled = false;
                statusSpan.textContent = '已停止';
            });
        });

        // 版本检查
        fetch('http://nas.shanghaiit.com:88/PingToolsVer.txt')
            .then(response => response.text())
            .then(remoteVersion => {
                const localVersion = '0.1';
                const versionUpdateElement = document.getElementById('versionUpdate');
                if (remoteVersion.trim() !== localVersion.trim()) {
                    // 弹出提示
                    if (confirm('检测到新版本 PingTools，是否下载更新？')) {
                        window.open('http://nas.shanghaiit.com:88/PingTools.rar', '_blank');
                    }
                    // 在页面上显示新版本提示
                    versionUpdateElement.innerHTML = `检测到新版本 ${remoteVersion.trim()}, 点击下载`;
                    versionUpdateElement.onclick = function() {
                        window.open('http://nas.shanghaiit.com:88/PingTools.rar', '_blank');
                    };
                } else {
                    // 版本相同，不显示提示
                    versionUpdateElement.innerHTML = '';
                }
            })
            .catch(error => {
                console.error('版本检查失败:', error);
                // 版本检查失败时不影响正常使用
            });
    </script>
    <div style="text-align: center; margin: 20px 0;">
        <p>作者: <a href="https://github.com/git-howard/" target="_blank">https://github.com/git-howard/</a> | 版本: <span id="localVersion">0.1</span></p>
        <div id="versionUpdate" style="color: red; margin-top: 10px; cursor: pointer;"></div>
    </div>
</body>
</html>